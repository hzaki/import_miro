on:
  workflow_dispatch:
    inputs:
      prefix:
        description: "Préfixe des frames (idempotence légère)"
        type: string
        default: "R4"
        required: true
      csv_path:
        description: "Chemin vers un CSV dans le repo (ex: data/storymap_r4.csv)"
        type: string
        required: false
      dry_run:
        description: "Ne pas écrire dans Miro, seulement afficher"
        type: choice
        options: ["true", "false"]
        default: "true"
        required: true

permissions:
  contents: read

concurrency:
  group: miro-storymap-r4
  cancel-in-progress: false

jobs:
  run:
    name: Publier le Story Mapping R4
    runs-on: ubuntu-latest
    env:
      MIRO_TOKEN: ${{ secrets.MIRO_TOKEN }}
      MIRO_BOARD_ID: ${{ secrets.MIRO_BOARD_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Echo inputs & list repo
        run: |
          echo "Inputs: prefix='${{ inputs.prefix }}' csv_path='${{ inputs.csv_path }}' dry_run='${{ inputs.dry_run }}'"
          echo "Repo root:"
          ls -la
          echo "Top-level files:" 
          find . -maxdepth 2 -type f -print | sort

      - name: Validate files
        shell: bash
        run: |
          set -euo pipefail
          SCRIPT=push_storymap_r4_to_miro.py
          if [[ ! -f "$SCRIPT" ]]; then
            echo "❌ Fichier manquant: $SCRIPT (attendu à la racine du repo)." >&2
            echo "👉 Solution: ajoute $SCRIPT à la racine, ou modifie le workflow pour pointer vers son chemin réel." >&2
            exit 2
          fi
          if [[ -n "${{ inputs.csv_path }}" ]]; then
            if [[ ! -f "${{ inputs.csv_path }}" ]]; then
              echo "❌ CSV introuvable: ${{ inputs.csv_path }}" >&2
              echo "👉 Solution: vérifie le chemin (ex: data/storymap_r4.csv) ou laisse le champ vide pour utiliser le modèle par défaut." >&2
              exit 2
            fi
          fi
          echo "✅ Validation OK: $SCRIPT présent et CSV (si fourni) trouvé."

      - name: Installer dépendances
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests pandas python-slugify
          fi

      - name: Pré-vérification accès Miro (optionnel)
        shell: bash
        run: |
          set -e
          if [[ -z "${MIRO_TOKEN}" || -z "${MIRO_BOARD_ID}" ]]; then
            echo "⚠️  MIRO_TOKEN ou MIRO_BOARD_ID non défini(s). Passe à l'étape suivante, mais l'appel API échouera." >&2
            exit 0
          fi
          python - << 'PY'
import os, requests
T=os.environ.get('MIRO_TOKEN'); B=os.environ.get('MIRO_BOARD_ID')
h={'Authorization': f'Bearer {T}'}
r=requests.get(f'https://api.miro.com/v2/boards/{B}', headers=h, timeout=30)
print('HTTP', r.status_code)
try:
  j=r.json()
  print('Board:', j.get('name'), '| ID:', j.get('id'))
except Exception:
  print('Réponse non JSON')
r.raise_for_status()
PY

      - name: Exécuter le script Story Mapping R4
        shell: bash
        run: |
          set -euo pipefail
          args=( --board "$MIRO_BOARD_ID" --prefix "${{ inputs.prefix }}" )
          if [ -n "${{ inputs.csv_path }}" ]; then
            args+=( --csv "${{ inputs.csv_path }}" )
          fi
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            args+=( --dry-run )
          fi
          echo "Commande: python push_storymap_r4_to_miro.py ${args[*]}"
          python push_storymap_r4_to_miro.py "${args[@]}"

      - name: Sauvegarde logs
        if: always()
        run: |
          echo "Run terminé à $(date -u +%Y-%m-%dT%H:%M:%SZ)" > run-summary.txt
          printf "Prefix: %s\nCSV: %s\nDry-run: %s\n" "${{ inputs.prefix }}" "${{ inputs.csv_path }}" "${{ inputs.dry_run }}" >> run-summary.txt

      - name: Upload logs (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: miro-storymap-r4-logs
          path: run-summary.txt
